# SaihAI v2.0 受け入れ確認チェックリスト（UAT / 検収）

関連:

- `docs/saihai-v2-system-requirements.md`
- `docs/saihai-v2-backend-functional-design.md`

## 0. 目的 / 使い方

- 本書は SaihAI v2.0 の **受け入れ（検収）** を行うためのチェックリストである。
- チェックは「チェック項目（What）」と「確認手順（How）」と「期待結果（Expected）」をセットで定義する。
- 受け入れ証跡（Evidence）は、原則として以下を残す:
  - Slack 画面キャプチャ（通知、ボタン操作、スレッド介入、完了通知）
  - API レスポンス（HTTP status / body）
  - サーバーログ（相関ID、thread_id、approval_request_id 等）
  - DB レコード（Aurora/Redis/Vector Store の確認結果）
- 記録先（推奨）: `evidence/acceptance/v2.0/`（運用に合わせて変更可）

## 1. 受け入れ条件（Definition of Done）

以下を満たした場合に「受け入れ完了」とする。

- **必須（Must）** のチェックがすべて Pass
- 重大障害（P0/P1）が 0 件
- 残課題がある場合は、**影響範囲 / 回避策 / リリース可否** が合意され、ドキュメント化されている

### 1.1 用語（本書内）

- `thread_id`: Slack のスレッドTS等をキーにしたセッション識別子（LangGraph 復元に使用）
- `approval_request_id`: 承認要求の一意ID（ボタン押下の重複・再送に対する冪等性に使用）
- 「承認」: 実行可の意思決定（Execute）
- 「介入」: 自然言語フィードバックでプラン/ドラフトを修正させる操作（Human-in-the-loop）

## 2. 前提 / 環境チェック（Pre-flight）

### 2.1 環境変数 / 認証情報（Must）

- [ ] **AC-ENV-001** Slack Bot Token が設定されている
  - 手順: Backend の設定（環境変数/Secret Manager）で `SLACK_BOT_TOKEN` 相当が投入されていることを確認
  - 期待: 起動時に認証エラーが出ない / Slack API 呼び出しが成功する
- [ ] **AC-ENV-002** Slack Signing Secret が設定されている
  - 手順: `SLACK_SIGNING_SECRET` 相当が投入されていることを確認
  - 期待: 正規リクエストは通過し、署名不一致は拒否される（詳細は AC-SEC-001）
- [ ] **AC-ENV-003** LLM 接続情報が設定されている（OpenAI / Bedrock のいずれか）
  - 手順: API キー/認証情報/モデル名が設定済みであることを確認
  - 期待: LLM 呼び出しが成功し、タイムアウト/認証エラーにならない
- [ ] **AC-ENV-004** Redis 接続情報が設定されている
  - 手順: 接続先、認証、TLS（必要なら）が設定済みであることを確認
  - 期待: 状態保存/復元ができる（詳細は AC-PER-001）
- [ ] **AC-ENV-005** Aurora（PostgreSQL）接続情報が設定されている（履歴/社員情報）
  - 手順: 接続先/認証が設定済みであることを確認
  - 期待: 社員情報・履歴ログの参照/保存ができる（詳細は AC-DB-001 / AC-DB-002）
- [ ] **AC-ENV-006** Vector Store（pgvector/Pinecone等）が利用可能
  - 手順: 埋め込み保存/検索が可能な設定になっていることを確認
  - 期待: 週報等の埋め込みが格納できる（詳細は AC-VEC-001 / AC-VEC-002）

### 2.2 Slack App 設定（Must）

- [ ] **AC-SLK-001** Events API / Interactivity の Request URL が正しく設定されている
  - 手順: Slack App 設定画面で Request URL を確認
  - 期待: テストイベント/ボタン押下で Backend に到達する
- [ ] **AC-SLK-002** 必要スコープが付与されている（chat:write 等）
  - 手順: Slack App の OAuth Scopes を確認
  - 期待: 投稿・更新・スレッド返信が権限不足にならない
- [ ] **AC-SLK-003** Slack Retry（再送）を考慮した実装・設定になっている
  - 手順: 同一 event_id の再送を想定し、処理が重複しないことを確認（AC-ROB-001）
  - 期待: 二重通知/二重実行が起こらない

### 2.3 疎通（Must）

- [ ] **AC-CONN-001** Backend のヘルスチェックが 200 を返す
  - 手順: `/health` 等のヘルスエンドポイントを叩く
  - 期待: 200 OK / 依存サービスを含む健全性が確認できる
- [ ] **AC-CONN-002** Slack からのイベント受信が 3 秒以内に ACK される
  - 手順: Slack 側からイベント送信→ Backend が即時 200 を返すことを確認
  - 期待: Slack 側でタイムアウト/リトライが過剰に発生しない

## 3. 機能受け入れ（FR）チェック

### 3.1 FR-001 監視データ収集（週報/勤怠/Slack）

- [ ] **AC-FR1-001** 週報データを取り込みできる
  - 手順: 週報データ（テキスト + 日付 + employee_id）を投入（API/バッチ等）
  - 期待: Aurora に原文が保存され、Vector Store に埋め込みが作成される（AC-VEC-001）
- [ ] **AC-FR1-002** Slack ログ（投稿/頻度/反応速度）を取得・保存できる
  - 手順: 対象チャンネル/DMで一定期間のログ取得を実行（またはイベント収集を稼働）
  - 期待: 投稿数、メッセージ本文、時刻等が保存され、分析入力として使用できる
- [ ] **AC-FR1-003** 勤怠ログを取得・保存できる
  - 手順: 勤怠連携（API/CSV等）でデータ投入
  - 期待: 勤怠の異常（残業増/欠勤等）を検知入力として利用できる
- [ ] **AC-FR1-004** 収集処理が冪等（同一データの再投入で重複しない）
  - 手順: 同一週報/同一Slackログ範囲を再投入し、差分のみ反映されることを確認
  - 期待: DB に重複行が増えない / embeddings が無駄に増殖しない

### 3.2 FR-002 異常検知（Watchdog / Monitor）

- [ ] **AC-FR2-001** Watchdog が定期実行される（24/7）
  - 手順: スケジューラ（EventBridge/Cron）で起動されることを確認
  - 期待: オフラインの Manager に依存せずに実行される（NFR-001）
- [ ] **AC-FR2-002** Watchdog が「異常候補リスト」を出力する
  - 手順: 複数社員データを用意し、1名だけ異常に寄せたデータで実行
  - 期待: その社員が上位に出る（異常スコアリストが生成される）
- [ ] **AC-FR2-003** Monitor Agent がリスク判定を JSON で返す
  - 手順: 週報/Slack履歴を入力し、Monitor を実行
  - 期待: `{ risk_level: 0-100, reason: string, urgency: High|Med|Low }` が取得できる
- [ ] **AC-FR2-004** Monitor の出力が不正（JSON壊れ等）の場合に復旧できる
  - 手順: LLM が壊れた JSON を返すケースを模擬（温度を上げる/テストスタブ等）
  - 期待: リトライ/再プロンプト/パーサで復旧し、ワークフローが異常終了しない

### 3.3 FR-003 自律根回し（Gunshi / Drafting）

- [ ] **AC-FR3-001** Gunshi がプラン A/B を提示できる
  - 手順: リスク判定 + 人事/プロジェクト情報を入力して Gunshi を実行
  - 期待: プラン候補（A/B）と推奨案、理由が出力される
- [ ] **AC-FR3-002** Drafting Agent がメール/申請書の下書きを生成できる
  - 手順: Gunshi のアクションプランを入力し Drafting を実行
  - 期待: `email_draft` と `approval_doc` が生成される（空文字/欠落がない）
- [ ] **AC-FR3-003** 生成物に必須情報が含まれる
  - 手順: メール・申請書のテンプレ要件（宛先、件名、要旨、依頼事項等）を確認
  - 期待: 必須項目が欠落しない / 不明点は明確な ToDo（質問）として出力される

### 3.4 FR-004 Slack通知（承認 / 介入 / 却下）

- [ ] **AC-FR4-001** Slack に提案通知が投稿される（プレビュー付き）
  - 手順: 異常検知→立案→下書き生成後、Checkpoint で通知を発火
  - 期待: リスク概要、対象社員、提案、ドラフトプレビューが表示される
- [ ] **AC-FR4-002** Slack に 3 ボタンが表示される
  - 手順: 通知メッセージの Block Kit を確認
  - 期待: `[承認(Execute)]` `[介入(Chat)]` `[却下]` が存在し、押下可能
- [ ] **AC-FR4-003** 通知が thread_id と紐づく
  - 手順: 送信 payload あるいは DB を参照し `thread_id` が保存されることを確認
  - 期待: 介入時に同一スレッドで Resume できる（AC-FR5-002）

### 3.5 FR-005 介入（Human-in-the-loop / Re-planning）

- [ ] **AC-FR5-001** 介入導線（スレッド返信 or 介入ボタン）が機能する
  - 手順: 通知に対して「送信は来週月曜にして」等を返信する（または介入ボタンを押して入力）
  - 期待: ワークフローが Resume され、Gunshi の再計算が走る
- [ ] **AC-FR5-002** Redis から thread_id の状態が復元される
  - 手順: 介入前に Backend を再起動する/処理を中断するなどして復元を検証
  - 期待: 介入前の文脈（previous_draft 等）を保持している（NFR-002）
- [ ] **AC-FR5-003** 修正案が即座に Slack へ再提示される
  - 手順: 介入送信後、修正案が返るまでの時間を測定
  - 期待: 目標 SLO 内（NFR-003、SLO は TBD だが「数秒」を目安）
- [ ] **AC-FR5-004** 介入内容が反映される（例: 送信予約日時の変更）
  - 手順: 「メール送信だけ来週月曜にして」など具体指示を与える
  - 期待: 変更点がドラフト/実行計画に反映され、他のタスクは維持される
- [ ] **AC-FR5-005** 介入ログが残る
  - 手順: DB/ログを参照し、介入入力と修正結果が追跡可能であることを確認
  - 期待: だれが/いつ/何を指示し/どう変わったかが監査できる

### 3.6 FR-006 実行（Action Execution）

- [ ] **AC-FR6-001** 承認ボタンで実行が開始される
  - 手順: `[承認(Execute)]` を押下
  - 期待: Action Executor が起動し、対象アクションが実行計画に従って処理される
- [ ] **AC-FR6-002** HR システム API POST が実行される（またはスタブで検証）
  - 手順: 模擬エンドポイント/本物の環境で API 呼び出しを確認
  - 期待: 正しい payload で 2xx を得る / 失敗時はリトライ or エラー通知（AC-ERR-xxx）
- [ ] **AC-FR6-003** Gmail API で送信予約が作成される（例: 来週月曜）
  - 手順: スケジュール指定の介入後に承認し、送信予約を確認
  - 期待: 送信日時が指定どおりである / 二重予約にならない（AC-ROB-002）
- [ ] **AC-FR6-004** カレンダーに「ケア面談」が作成される（仮押さえ）
  - 手順: 承認後にカレンダーを確認
  - 期待: 予定が作成され、参加者/時間帯/タイトルが正しい
- [ ] **AC-FR6-005** 実行完了が Slack に通知される
  - 手順: 実行完了まで待機し Slack を確認
  - 期待: 成功/失敗（部分失敗含む）がユーザーに伝わるメッセージになっている

### 3.7 FR-007 ダッシュボード（Dashboard）

- [ ] **AC-FR7-001** 履歴一覧が表示できる
  - 手順: Angular SPA にアクセスし、履歴画面を開く
  - 期待: 過去の提案/介入/実行が一覧表示される
- [ ] **AC-FR7-002** 詳細ログが追跡できる
  - 手順: 任意の履歴を開き、イベント詳細（分析理由、プラン、ドラフト、実行結果）を確認
  - 期待: 要件で定義した「詳細な分析ログ」「過去の対応履歴」が閲覧できる
- [ ] **AC-FR7-003** 検索/フィルタが機能する（社員/期間/状態など）
  - 手順: フィルタ UI を操作
  - 期待: 目的の履歴に素早く到達できる

## 4. 状態管理 / 永続化（Persistence）

- [ ] **AC-PER-001** Checkpoint で中断し、承認待ち状態が保存される
  - 手順: 下書き生成後に停止（承認待ち）させる
  - 期待: Redis に `current_state=承認待ち` 相当が保存される
- [ ] **AC-PER-002** 介入で Resume できる
  - 手順: 中断状態のスレッドへ返信
  - 期待: 正しい状態から処理が再開される（state を失わない）
- [ ] **AC-PER-003** 承認/却下で終端に遷移し、状態がクリーンアップされる（TBD）
  - 手順: 承認 or 却下を実行
  - 期待: 終了状態が保存され、不要な一時状態が残り続けない（保持期間はポリシーで定義）

## 5. データ / DB（Aurora / Redis / Vector）

### 5.1 Aurora（構造化）

- [ ] **AC-DB-001** Employees 情報を参照できる
  - 手順: `employee_id`, `name`, `department`, `risk_score` が参照できることを確認
  - 期待: Watchdog/Monitor が社員情報を利用できる
- [ ] **AC-DB-002** 履歴ログ（提案/介入/実行）が永続化される
  - 手順: 一連フローを実行し、履歴が残ることを確認
  - 期待: Dashboard から閲覧できる（AC-FR7-001）

### 5.2 Redis（ステート）

- [ ] **AC-RED-001** `thread_id` で状態が一意に管理される
  - 手順: 複数スレッドで同時に承認待ちを作る
  - 期待: スレッド間で状態が混線しない
- [ ] **AC-RED-002** `current_state` が遷移に応じて更新される
  - 手順: 承認待ち→修正中→承認待ち→実行中→完了 の遷移を確認
  - 期待: 遷移がログ/DBで追跡できる

### 5.3 Vector Store（非構造化）

- [ ] **AC-VEC-001** 週報テキストが埋め込みとして保存される
  - 手順: 週報を投入し、Vector Store にベクトルが存在することを確認
  - 期待: `content_vector` と `metadata`（日付, 感情ラベル等）が保存される
- [ ] **AC-VEC-002** 類似検索が動作し、分析に利用される（TBD）
  - 手順: 類似文の週報を用意し、検索でヒットすることを確認
  - 期待: Monitor/Gunshi の根拠に活用される（ログに参照が残ると良い）

## 6. ロバストネス / エラーハンドリング（Robustness）

- [ ] **AC-ROB-001** Slack Event の重複再送に対して二重処理しない
  - 手順: 同一 `event_id` を再送（Slack Retry を模擬）
  - 期待: 通知・状態遷移・実行が重複しない
- [ ] **AC-ROB-002** 承認ボタンの二重押しで二重実行しない
  - 手順: 同一 `approval_request_id` を複数回送信
  - 期待: 実行は 1 回のみ / 2 回目以降は「既に処理済み」として扱う
- [ ] **AC-ROB-003** LLM 失敗時にリトライし、最終的に失敗ならユーザーへ明示する
  - 手順: 一時的な 5xx/タイムアウトを模擬
  - 期待: 指数バックオフで再試行し、失敗時は Slack に失敗理由と次アクションを提示
- [ ] **AC-ROB-004** 外部アクション（メール/カレンダー/API）が部分失敗しても状態が矛盾しない
  - 手順: 1 つだけ失敗させる（例: Gmail だけ失敗）
  - 期待: 成功分/失敗分が区別され、再実行や手動対応が可能な形で通知/記録される

## 7. セキュリティ / 監査（Security & Audit）

- [ ] **AC-SEC-001** Slack 署名検証が機能し、不正リクエストは拒否される
  - 手順: 署名不一致のリクエストを送る
  - 期待: 401/403 などで拒否し、処理を開始しない
- [ ] **AC-SEC-002** Dashboard API に認証が必要（TBD）
  - 手順: 未認証で API/画面へアクセス
  - 期待: アクセスできない / 適切にリダイレクトされる
- [ ] **AC-SEC-003** ログに機密情報（トークン/個人情報）が平文で出ない
  - 手順: 実行ログを確認
  - 期待: トークンや秘匿対象がマスクされている
- [ ] **AC-AUD-001** 監査ログで「誰が何を承認/却下/介入したか」が追跡できる
  - 手順: 承認/却下/介入を実施し、履歴を確認
  - 期待: actor、timestamp、対象（employee_id）、変更点、実行結果が記録される

## 8. 可観測性 / 運用（Observability & Ops）

- [ ] **AC-OBS-001** 相関ID（thread_id / approval_request_id 等）で追跡できる
  - 手順: 1件のフローを通し、ログで検索できることを確認
  - 期待: 受信→推論→通知→介入→実行の全ログが紐づく
- [ ] **AC-OBS-002** LLM コスト管理のための計測がある（入力/出力トークン、レイテンシ）
  - 手順: LLM 呼び出しログ/メトリクスを確認
  - 期待: コストと性能の把握が可能
- [ ] **AC-OPS-001** 失敗時の通知ルートがある（Slack/メール/監視アラート等、TBD）
  - 手順: 意図的に失敗を起こす
  - 期待: 運用者が気づける形で通知される

## 9. 非機能（NFR）チェック

- [ ] **AC-NFR-001** 可用性: Manager がオフラインでも Watchdog 監視が継続する
  - 手順: Manager 操作無しで定期ジョブが動き、翌朝に通知が来ることを確認
  - 期待: 監視と検知は継続される（NFR-001）
- [ ] **AC-NFR-002** データ整合性: 介入で中断→再開してもコンテキストが保持される
  - 手順: 承認待ちで停止→Backend 再起動→介入
  - 期待: 直前のドラフト/プランが復元される（NFR-002）
- [ ] **AC-NFR-003** レスポンス: 介入指示→再提示が即座
  - 手順: 介入送信から修正案提示までの時間を複数回測定（p50/p95）
  - 期待: 目標（例: p95 < 5 秒、p99 < 10 秒）を満たす（目標値は合意の上で確定）

## 10. 代表シナリオ受け入れ（E2E）

本番に近い形で「一連フローが成立すること」を検証する。

### 10.1 シナリオ: 燃え尽き検知 → 介入 → 実行

- [ ] **AC-E2E-001** Watchdog が深夜に異常を検知する
  - 手順: 田中氏相当のデータ（「飽きた」等）を用意し、定期実行を待つ（または手動起動）
  - 期待: 異常候補に上がる
- [ ] **AC-E2E-002** Gunshi がプランB（技術顧問化）を含む提案を生成する
  - 手順: Monitor→Gunshi を通す
  - 期待: プラン候補と理由、推奨が出る
- [ ] **AC-E2E-003** Drafting がクライアント向けメールと人事申請書を生成する
  - 手順: Drafting を通す
  - 期待: 2種類の下書きが出る
- [ ] **AC-E2E-004** Slack へ 9:00 の通知が届く（予約 or 実送）
  - 手順: 通知スケジューリングを確認
  - 期待: 指定時刻に通知が届く
- [ ] **AC-E2E-005** Manager が「メール送信だけ来週月曜にして」と介入する
  - 手順: スレッド返信
  - 期待: 修正案が返り、送信予約が更新される
- [ ] **AC-E2E-006** Manager が承認し、3アクションが実行される
  - 手順: 承認ボタン押下
  - 期待: HR API POST / Gmail 送信予約 / カレンダー仮押さえが成立する
- [ ] **AC-E2E-007** Slack に完了通知が出て、Dashboard に履歴が残る
  - 手順: Slack と Dashboard を確認
  - 期待: 「完了」メッセージと履歴/ログが確認できる

## 11. 受け入れ結果記録（テンプレ）

| ID | 結果 | 実施日 | 実施者 | 証跡リンク/パス | 備考 |
| --- | --- | --- | --- | --- | --- |
| AC-... | Pass/Fail | YYYY-MM-DD | name | evidence/... |  |
